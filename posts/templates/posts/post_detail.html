<!DOCTYPE html>
<html>
<head>
    <title>{{ post.title }}</title>
    {% load static %}
    <link rel="stylesheet" type="text/css" href="{% static 'css/PostDetail.css' %}">
</head>
<body>
    <h1>{{ post.title }}</h1>
    
    <!-- Display post metadata / 显示帖子元数据（GJ） -->
    <p><strong>Description:</strong> {{ post.description }}</p>
    <p class="content"><strong>Content:</strong> {{ post.content }}</p>
    <p><strong>Published:</strong> {{ post.published }}</p>
    <p><strong>Visibility:</strong> {{ post.visibility }}</p>

    <!-- display images -->
    {% if post.image %}
        <img src="{{ post.image }}" alt="{{ post.title }} Image" style="max-width: 100%;">
    {% else %}
        <p><em>No image available for this post.</em></p>
    {% endif %}

    <!-- Like button form -->
    <form action="{% url 'posts:like_post' post.id %}" method="POST">
        {% csrf_token %}
        <button type="submit" 
                class="like-button {% if post.is_liked_by_user %}liked{% else %}unliked{% endif %}">
            {% if post.is_liked_by_user %}
                Unlike
            {% else %}
                Like
            {% endif %}
            ({{ post.likes.count }})
        </button>
    </form>

    <a href="{% url 'posts:post_likes' post.id %}" class="likes-list-button">
        View Likes ({{ post.likes.count }})
    </a>
    
    <!-- Comment form -->
    <form id="comment-form" action="{% url 'posts:add_comment' post.id %}" method="POST" class="comment-form">
        {% csrf_token %}
        <label for="comment-content">Comment:</label>
        <textarea id="comment-content" name="content" required></textarea>
        <button type="submit">Add Comment</button>
    </form>

    <!-- Comment list -->
    <h2>Comments</h2>
    <ul id="comment-list">
        {% for comment in post.comments.all %}
            <li>
                <strong>{{ comment.user.username }}</strong>: {{ comment.content }} 
                <p>Likes: {{ comment.like_count }}</p>
                <!-- Like button for comment -->
                {% if user == comment.post.author or user in comment.post.author.friends.all %}
                    <form action="{% url 'posts:like_comment' post.id comment.id %}" method="POST">
                        {% csrf_token %}
                        <button type="submit" class="like-button {% if comment.is_liked_by_user %}liked{% else %}unliked{% endif %}">
                            {% if comment.is_liked_by_user %} Unlike {% else %} Like {% endif %}
                        </button>
                    </form>
                {% endif %}
            </li>
        {% empty %}
            <li><em>No comments yet.</em></li>
        {% endfor %}
    </ul>

    {% if post.visibility == "DELETED" %}
        <!-- Show deleted message if the post is marked as deleted / 如果帖子被标记为删除，显示红色警告（GJ） -->
        <p id="deleted-warning"><strong>This post has been deleted.</strong></p>
    {% endif %}

    {% if user == post.author %}
        <!-- If the logged-in user is the author, allow editing / 如果当前用户是帖子作者，则允许编辑（GJ） -->
        <a href="{% url 'posts:edit_post' post.id %}">Edit</a>

        <!-- Delete post form / 删除帖子表单（GJ） -->
        <form action="{% url 'posts:delete_post' post.id %}" method="post" style="display:inline;">
            {% csrf_token %}
            <button type="submit">Delete</button>
        </form>
    {% endif %}

    <br>
    <!-- Back to posts list / 返回帖子列表（GJ） -->
    <a href="{% url 'posts:index' %}">Back to Posts</a>
    {% if post.contentType == "text/markdown" %}
        <script src="{% static 'markdown-renderer.min.js' %}"></script> <!-- Load bundled JS -->
    {%endif%}

     <!-- JavaScript to dynamically update the comment list -->
     <script>
        document.addEventListener("DOMContentLoaded", function() {
          const commentForm = document.getElementById("comment-form");
          if (commentForm) {
            commentForm.addEventListener("submit", function(event) {
              event.preventDefault();
              // Create FormData object from the form
              const formData = new FormData(commentForm);
              
              fetch(commentForm.action, {
                method: "POST",
                credentials: "same-origin",
                body: formData
              })
              .then(response => response.json())
              .then(data => {
                console.log("Comment added:", data);
                
                const commentList = document.getElementById("comment-list");
                
                // Remove any li elements that say "No comments yet."
                commentList.querySelectorAll("li").forEach(li => {
                  if (li.textContent.includes("No comments yet.")) {
                    li.remove();
                  }
                });
                
                // If the response contains a comment object, add it to the list
                if (data.comment) {
                  const newComment = document.createElement("li");
                  newComment.innerHTML = `<strong>${data.comment.author}</strong>: ${data.comment.content}`;
                  commentList.prepend(newComment);
                }
                
                // Clear the textarea after submission
                commentForm.querySelector('textarea[name="content"]').value = "";
              })
              .catch(error => console.error("Error adding comment:", error));
            });
          }
        });
      </script>      
</body>
</html>
