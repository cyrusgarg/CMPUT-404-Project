<!DOCTYPE html>
<html>
<head>
    <title>{{ post.title }}</title>
    {% load static %}
    <meta name="csrf-token" content="{{ csrf_token }}">
    <link rel="stylesheet" type="text/css" href="{% static 'css/PostDetail.css' %}">
</head>
<body>
    <h1>{{ post.title }}</h1>
    
    <!-- Display post metadata / 显示帖子元数据（GJ） -->
    <p><strong>Description:</strong> {{ post.description }}</p>
    <p class="content"><strong>Content:</strong> {{ post.content }}</p>
    <p><strong>Published:</strong> {{ post.published }}</p>
    <p><strong>Visibility:</strong> {{ post.visibility }}</p>

    <!-- display images -->
    {% if post.image %}
        <img src="{{ post.image }}" alt="{{ post.title }} Image" style="max-width: 100%;">
    {% else %}
        <p><em>No image available for this post.</em></p>
    {% endif %}

    <!-- Like button form -->
    <form action="{% url 'posts:like_post' post.id %}" method="POST">
        {% csrf_token %}
        <button type="submit" 
                class="like-button {% if post.is_liked_by_user %}liked{% else %}unliked{% endif %}">
            {% if post.is_liked_by_user %}
                Unlike
            {% else %}
                Like
            {% endif %}
            ({{ post.likes.count }})
        </button>
    </form>

    <a href="{% url 'posts:post_likes' post.id %}" class="likes-list-button">
        View Likes ({{ post.likes.count }})
    </a>
    
    <!-- Comment form -->
    <form id="comment-form" action="{% url 'posts:add_comment' post.id %}" method="POST" class="comment-form">
        {% csrf_token %}
        <label for="comment-content">Comment:</label>
        <textarea id="comment-content" name="content" required></textarea>
        <button type="submit">Add Comment</button>
    </form>

    <!-- Comment list -->
    <h2>Comments</h2>
    <ul id="comment-list">
        {% for comment in comments %}
            <li data-comment-id="{{ comment.id }}">
                <strong>{{ comment.user.username }}</strong>: {{ comment.content }}
                <p>Likes: <span class="like-count">{{ comment.like_count }}</span></p>
                <!-- Like button for comment -->
                <form action="{% url 'posts:like_comment' post.id comment.id %}" method="POST" class="like-comment-form">
                    {% csrf_token %}
                    <button type="submit" class="like-button {% if comment.is_liked_by_user %}liked{% else %}unliked{% endif %}">
                        {% if comment.is_liked_by_user %}Liked{% else %}Like{% endif %}
                    </button>
                </form>
            </li>
        {% empty %}
            <li><em>No comments yet.</em></li>
        {% endfor %}
    </ul>    

    {% if post.visibility == "DELETED" %}
        <!-- Show deleted message if the post is marked as deleted / 如果帖子被标记为删除，显示红色警告（GJ） -->
        <p id="deleted-warning"><strong>This post has been deleted.</strong></p>
    {% endif %}

    {% if user == post.author %}
        <!-- If the logged-in user is the author, allow editing / 如果当前用户是帖子作者，则允许编辑（GJ） -->
        <a href="{% url 'posts:edit_post' post.id %}">Edit</a>

        <!-- Delete post form / 删除帖子表单（GJ） -->
        <form action="{% url 'posts:delete_post' post.id %}" method="post" style="display:inline;">
            {% csrf_token %}
            <button type="submit">Delete</button>
        </form>
    {% endif %}

    {% if post.visibility == "PUBLIC" or post.visibility == "UNLISTED" %}
    <div class="share-section">
        <p><strong>Share this post:</strong></p>
        <div class="share-link-container">
            <input type="text" id="share-link" value="{{ request.scheme }}://{{ request.get_host }}{% url 'posts:shared_post' post.id %}" readonly>
            <button id="copy-link-btn" onclick="copyShareLink()">Copy Link</button>
        </div>
        <p id="copy-confirmation" style="display: none; color: green;">Link copied to clipboard!</p>
    </div>
    {% endif %}
    <br>
    <!-- Back to posts list / 返回帖子列表（GJ） -->
    <a href="{% url 'posts:index' %}">Back to Posts</a>
    {% if post.contentType == "text/markdown" %}
        <script src="{% static 'markdown-renderer.min.js' %}"></script> <!-- Load bundled JS -->
    {%endif%}

     <!-- JavaScript to dynamically update the comment list and handle like-comment form -->
     <script>
        document.addEventListener("DOMContentLoaded", function() {
            // Function to attach AJAX event listeners to all like-comment forms.
            function attachLikeCommentListeners() {
                const likeForms = document.querySelectorAll('.like-comment-form');
                likeForms.forEach(form => {
                    // Remove any existing event listeners if necessary before attaching
                    form.addEventListener("submit", function(e) {
                        e.preventDefault(); // Prevent default form submission
                        const url = form.action;
                        const csrfToken = form.querySelector('[name=csrfmiddlewaretoken]').value;
                        
                        fetch(url, {
                            method: "POST",
                            credentials: "same-origin",
                            headers: {
                                "X-CSRFToken": csrfToken,
                                "Accept": "application/json",
                            },
                        })
                        .then(response => response.json())
                        .then(data => {
                            // Locate the parent list item and update like count
                            const commentItem = form.closest('li');
                            const likeCountElem = commentItem.querySelector('.like-count');
                            likeCountElem.textContent = data.like_count;
                            // Update button text and styling
                            const button = form.querySelector('button');
                            if (data.liked) {
                                button.textContent = "Liked";
                                button.classList.remove("unliked");
                                button.classList.add("liked");
                            } else {
                                button.textContent = "Like";
                                button.classList.remove("liked");
                                button.classList.add("unliked");
                            }
                        })
                        .catch(error => console.error("Error:", error));
                    });
                });
            }
            
            // Initially attach listeners to existing like-comment forms.
            attachLikeCommentListeners();

            // Handle comment form submission via AJAX
            const commentForm = document.getElementById("comment-form");
            if (commentForm) {
                commentForm.addEventListener("submit", function(event) {
                    event.preventDefault();
                    // Create FormData object from the form
                    const formData = new FormData(commentForm);
                    
                    fetch(commentForm.action, {
                        method: "POST",
                        credentials: "same-origin",
                        body: formData
                    })
                    .then(response => response.json())
                    .then(data => {
                        console.log("Comment added:", data);
                        
                        const commentList = document.getElementById("comment-list");
                        
                        // Remove any li elements that say "No comments yet."
                        commentList.querySelectorAll("li").forEach(li => {
                            if (li.textContent.includes("No comments yet.")) {
                                li.remove();
                            }
                        });
                        
                        if (data.comment) {
                            const newComment = document.createElement("li");
                            newComment.setAttribute("data-comment-id", data.comment.id);
                            newComment.innerHTML = `
                                <strong>${data.comment.author}</strong>: ${data.comment.content}
                                <p>Likes: <span class="like-count">0</span></p>
                                <form action="/posts/{{ post.id }}/comment/${data.comment.id}/like/" method="POST" class="like-comment-form">
                                    <input type="hidden" name="csrfmiddlewaretoken" value="{{ csrf_token }}">
                                    <button type="submit" class="like-button unliked">Like</button>
                                </form>
                            `;
                            commentList.prepend(newComment);
                            // Re-attach event listeners for newly added like-comment forms.
                            attachLikeCommentListeners();
                        }
                        
                        // Clear the textarea after submission
                        commentForm.querySelector('textarea[name="content"]').value = "";
                    })
                    .catch(error => console.error("Error adding comment:", error));
                });
            }
        });
    </script>      

    <script>
        function copyShareLink() {
            var shareLink = document.getElementById("share-link");
            shareLink.select();
            shareLink.setSelectionRange(0, 99999); /* For mobile devices */
            document.execCommand("copy");
            
            // Show confirmation message
            var confirmation = document.getElementById("copy-confirmation");
            confirmation.style.display = "block";
            
            // Hide confirmation after 3 seconds
            setTimeout(function() {
                confirmation.style.display = "none";
            }, 3000);
        }
    </script>
</body>
</html>
